<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Student Feedback</title>
    <style>
        :root {
            --primary-text: #ffffff;
            /* Changed to Black/Dark Gradient */
            --glass-bg: linear-gradient(135deg, rgba(0, 0, 0, 0.85), rgba(40, 40, 40, 0.9));
            --glass-border: rgba(255, 255, 255, 0.15);
            --table-header: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(0, 0, 0, 0.5);
            /* Removed specific rating colors as they will not be used */
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Red Gradient Background (Kept as requested earlier) */
            background: linear-gradient(135deg, #8E0E00, #1F1C18); 
            color: var(--primary-text);
            min-height: 100vh;
        }

        /* Top Navigation Bar */
        .top-bar {
            width: 100%;
            padding: 15px 40px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* User Menu & Dropdown Styles */
        .user-menu-wrapper {
            position: relative;
        }

        .profile-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .dropdown-menu {
            display: none; /* Hidden by default */
            position: absolute;
            right: 0;
            top: 60px;
            /* Black Glass style */
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            overflow: hidden;
            z-index: 2000;
            animation: fadeIn 0.2s ease forwards;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
            transition: background 0.2s;
            text-decoration: none;
        }

        .dropdown-item:hover {
            /* Dark Grey Hover */
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Layout */
        .main-content {
            padding: 40px 5%;
            padding-bottom: 80px;
        }

        .heading-container {
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 2rem;
            color: #ffffff;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Search Bar Styles */
        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            width: 100%;
        }

        .search-wrapper {
            position: relative;
            width: fit-content;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
            z-index: 10;
        }

        .search-box {
            background: rgba(0, 0, 0, 0.4); /* Darker search box */
            border: 1px solid var(--glass-border);
            padding: 12px 50px 12px 50px; 
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            width: 400px;
            outline: none;
            backdrop-filter: blur(5px);
            text-align: center;
            transition: all 0.3s ease;
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-box:focus {
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            width: 450px;
            border-color: rgba(255,255,255,0.3);
        }

        /* Export Button */
        .export-container {
            display: flex;
            justify-content: center;
            margin-top: 25px;
        }

        .export-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 30px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.4);
        }

        /* --- SUMMARY METRICS BAR STYLES --- */
        .metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-text);
            /* Ensure long names wrap */
            word-wrap: break-word; 
            padding: 0 5px; 
            line-height: 1.2;
        }
        
        /* Adjust font size for metric names that are too long */
        #topFaculty, #worstFaculty {
             font-size: 1.4rem; /* Slightly smaller font for names/scores */
        }

        /* Black Glass Table Container */
        .table-container {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            min-width: 1000px;
        }

        th {
            background: var(--table-header);
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            color: #aaaaaa; /* Light grey header text for contrast */
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            position: relative; /* For sort indicator */
        }

        /* Sort Indicator Styles */
        .sort-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        th.sorted .sort-indicator {
            opacity: 1;
        }

        th:first-child { border-radius: 10px 0 0 10px; }
        th:last-child { border-radius: 0 10px 10px 0; }

        tbody tr {
            background: rgba(255, 255, 255, 0.03); /* Very subtle row background */
            transition: all 0.3s ease;
        }

        td {
            padding: 15px;
            border: none;
            color: #ffffff; /* All table cell text is white */
            font-size: 0.95rem;
            text-shadow: none;
        }

        /* Round corners for the rows */
        tbody tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        /* Hover Effects */
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.01);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            cursor: default;
            z-index: 10;
            position: relative;
        }

        .rating-cell {
            font-weight: bold;
        }
        
        /* Force all rating visuals (text and metrics) to be white */
        .rating-visual, .rating-visual-white {
            font-weight: 700;
            color: var(--primary-text) !important; 
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 15px;
            }
            .search-box {
                width: 90%;
            }
        }
    </style>
</head>
<body>

    <!-- Top Navigation Bar --><div class="top-bar">
        <div class="brand-title">Admin Panel</div>
        
        <!-- User Profile & Dropdown --><div class="user-menu-wrapper">
            <button class="profile-btn" onclick="toggleDropdown(event)" title="Account Options">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
            
            <div id="userDropdown" class="dropdown-menu">
                <div class="dropdown-item" onclick="logout()">
                    <span>Logout</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="heading-container">
            <h2>Student Feedback Overview</h2>
        </div>

        <!-- SUMMARY METRICS BAR --><div id="metricsBar" class="metrics-bar">
            <!-- Cards will be populated by JS --><div class="metric-card">
                <div class="metric-label">Total Responses</div>
                <div id="totalResponses" class="metric-value">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Top Rated Faculty</div>
                <div id="topFaculty" class="metric-value">N/A</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Lowest Rated Faculty</div>
                <div id="worstFaculty" class="metric-value">N/A</div>
            </div>
        </div>
        
        <!-- Centered Search Bar with Transparent Icon --><div class="search-container">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="searchInput" class="search-box" placeholder="Search student, faculty, or subject..." onkeyup="filterTable()">
            </div>
        </div>

        <!-- Black Glass Table Container --><div class="table-container">
            <table id="feedbackTable">
                <thead>
                    <tr>
                        <th data-sort-key="id" onclick="sortTable('id', this)">ID <span class="sort-indicator"></span></th>
                        <th data-sort-key="studentName" onclick="sortTable('studentName', this)">Student <span class="sort-indicator"></span></th>
                        <th data-sort-key="rollNo" onclick="sortTable('rollNo', this)">Roll No <span class="sort-indicator"></span></th>
                        <th data-sort-key="department" onclick="sortTable('department', this)">Dept <span class="sort-indicator"></span></th>
                        <th data-sort-key="semester" onclick="sortTable('semester', this)">Sem <span class="sort-indicator"></span></th>
                        <th data-sort-key="subject" onclick="sortTable('subject', this)">Subject <span class="sort-indicator"></span></th>
                        <th data-sort-key="facultyName" onclick="sortTable('facultyName', this)">Faculty <span class="sort-indicator"></span></th>
                        <th data-sort-key="knowledge" onclick="sortTable('knowledge', this)">Knowledge <span class="sort-indicator"></span></th>
                        <th data-sort-key="communication" onclick="sortTable('communication', this)">Communication <span class="sort-indicator"></span></th>
                        <th data-sort-key="clarity" onclick="sortTable('clarity', this)">Clarity <span class="sort-indicator"></span></th>
                        <th data-sort-key="interaction" onclick="sortTable('interaction', this)">Interaction <span class="sort-indicator"></span></th>
                        <th>Likes</th>
                        <th>Suggestions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be injected here by JS --></tbody>
            </table>
        </div>

        <!-- Export Button Below Table --><div class="export-container">
            <button onclick="exportToCSV()" class="export-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Export CSV
            </button>
        </div>

    </div>

<script>
    // ========================
    //  GLOBAL VARIABLES
    // ========================
    let feedbackData = []; 
    let currentSort = { key: 'id', direction: 'asc' }; // Track current sorting state

    // ========================
    //  DROPDOWN TOGGLE LOGIC
    // ========================
    function toggleDropdown(event) {
        event.stopPropagation();
        const menu = document.getElementById("userDropdown");
        menu.classList.toggle("show");
    }

    window.onclick = function(event) {
        const menu = document.getElementById("userDropdown");
        if (menu.classList.contains("show")) {
            menu.classList.remove("show");
        }
    }

    // ========================
    //  ROLE & TOKEN CHECK (Kept commented out as requested)
    // ========================
    const token = localStorage.getItem("token");
    const role  = localStorage.getItem("role");
    
    // ========================
    // FETCH ALL FEEDBACK (Uncomment this block for live API usage)
    // ========================
    
    fetch("/feedback/all", {
        method: "GET",
        headers: {
            "Authorization": "Bearer " + token
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error("Invalid or expired token");
        }
        return res.json();
    })
    .then(data => {
        feedbackData = data; 
        renderTable(data);
        updateMetrics(data); 
    })
    .catch(err => {
        console.error(err);
    });
    

    // ========================
    // Helper to determine rating color class (always returns white now)
    // ========================
    function getRatingColor(rating) {
        // As requested, always return a class that makes the text white
        return 'rating-visual-white'; // A class to enforce white color via CSS
    }
    
    // ========================
    // Function to map text ratings to numeric scores (needed for metrics and sorting)
    // ========================
    function mapRatingToScore(rating) {
        if (typeof rating === 'number') return rating; // Handle if data is already numeric

        const lowerRating = String(rating).toLowerCase().trim();
        switch (lowerRating) {
            case 'excellent':
            case 'very good': 
                return 5;
            case 'good':
                return 4;
            case 'average':
                return 3;
            case 'poor':
                return 2;
            case 'very poor':
                return 1;
            default:
                return 0; // Treat unknown/missing data as 0
        }
    }


    // ========================
    // RENDER & LOGIC FUNCTIONS
    // ========================
    
    /**
     * Calculates and displays key metrics (Totals, Best/Worst Faculty)
     * @param {Array<Object>} data - The full dataset.
     * @returns {Object} - An object mapping faculty name to average score.
     */
    function updateMetrics(data) {
        document.getElementById('totalResponses').textContent = data.length;
        
        if (data.length === 0) {
            document.getElementById('topFaculty').textContent = 'N/A';
            document.getElementById('worstFaculty').textContent = 'N/A';
            return {};
        }

        // Data structure for calculating faculty averages: { facultyName: { totalScore: number, count: number } }
        const facultyScores = {}; 

        data.forEach(f => {
            // Use mapRatingToScore to ensure all values are numeric before summing
            const k = mapRatingToScore(f.knowledge);
            const c = mapRatingToScore(f.communication);
            const cl = mapRatingToScore(f.clarity);
            const i = mapRatingToScore(f.interaction);
            
            const score = k + c + cl + i;
            
            // We only calculate an average if at least one score was valid (score > 0)
            let validCount = 0;
            if (k > 0) validCount++;
            if (c > 0) validCount++;
            if (cl > 0) validCount++;
            if (i > 0) validCount++;

            if (validCount === 0) return; // Skip if no valid ratings were provided for this entry

            const averageEntryScore = score / validCount;
            
            // Calculate Faculty Averages
            const facultyKey = f.facultyName;
            if (!facultyScores[facultyKey]) {
                facultyScores[facultyKey] = { totalScore: 0, count: 0 };
            }
            // Sum the average score for this entry to the faculty's total
            facultyScores[facultyKey].totalScore += averageEntryScore;
            facultyScores[facultyKey].count++;
        });

        // 2. Determine Best/Worst Faculty & finalize averages
        let bestFaculty = { name: 'N/A', avg: -1 };
        let worstFaculty = { name: 'N/A', avg: 6 };
        const facultyAverages = {};
        
        for (const name in facultyScores) {
            const avg = (facultyScores[name].totalScore / facultyScores[name].count);
            facultyAverages[name] = avg;
            
            if (avg > bestFaculty.avg) {
                bestFaculty = { name, avg };
            }
            if (avg < worstFaculty.avg) {
                worstFaculty = { name, avg };
            }
        }
        
        // 3. Update Metric Cards
        
        // Top Faculty Card
        if (bestFaculty.name !== 'N/A') {
            document.getElementById('topFaculty').textContent = `${bestFaculty.name} (${bestFaculty.avg.toFixed(1)})`;
            // Apply the 'white' color class
            document.getElementById('topFaculty').className = 'metric-value rating-visual-white';
        } else {
             document.getElementById('topFaculty').textContent = 'N/A';
             document.getElementById('topFaculty').className = 'metric-value';
        }
        
        // Worst Faculty Card
        if (worstFaculty.name !== 'N/A') {
            document.getElementById('worstFaculty').textContent = `${worstFaculty.name} (${worstFaculty.avg.toFixed(1)})`;
            // Apply the 'white' color class
            document.getElementById('worstFaculty').className = 'metric-value rating-visual-white';
        } else {
             document.getElementById('worstFaculty').textContent = 'N/A';
             document.getElementById('worstFaculty').className = 'metric-value';
        }

        return facultyAverages;
    }


    /**
     * Renders the table rows based on the current filtered/sorted data.
     * @param {Array<Object>} data - The data to render.
     */
    function renderTable(data) {
        const tbody = document.querySelector("#feedbackTable tbody");
        tbody.innerHTML = ""; 

        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding: 20px;">No records found. (Check console for API connection status if this is unexpected.)</td></tr>`;
            return;
        }

        data.forEach(f => {
            // All ratings will now use the 'rating-visual-white' class for consistent white color
            const knowledgeColorClass = getRatingColor(f.knowledge);
            const communicationColorClass = getRatingColor(f.communication);
            const clarityColorClass = getRatingColor(f.clarity);
            const interactionColorClass = getRatingColor(f.interaction);

            tbody.innerHTML += `
                <tr>
                    <td>#${f.id}</td>
                    <td style="font-weight:600;">${f.studentName}</td>
                    <td>${f.rollNo}</td>
                    <td><span style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px;">${f.department}</span></td>
                    <td>${f.semester}</td>
                    <td>${f.subject}</td>
                    <td>${f.facultyName}</td>
                    <td class="rating-visual ${knowledgeColorClass}">${f.knowledge}</td>
                    <td class="rating-visual ${communicationColorClass}">${f.communication}</td>
                    <td class="rating-visual ${clarityColorClass}">${f.clarity}</td>
                    <td class="rating-visual ${interactionColorClass}">${f.interaction}</td>
                    <td>${f.likes}</td>
                    <td style="font-style:italic; opacity: 0.9;">${f.suggestions}</td>
                </tr>
            `;
        });
    }

    /**
     * Filters the table data based on search input and reapplies current sort.
     */
    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        
        const filtered = feedbackData.filter(item => {
            return (
                String(item.studentName).toLowerCase().includes(input) ||
                String(item.facultyName).toLowerCase().includes(input) ||
                String(item.subject).toLowerCase().includes(input) ||
                String(item.rollNo).includes(input)
            );
        });

        // Reapply the current sort to the filtered list
        const sorted = sortData(filtered, currentSort.key, currentSort.direction);
        renderTable(sorted);
        
        // Update metrics with the filtered data
        updateMetrics(filtered);
    }

    /**
     * Generic function to sort the table data in memory.
     * @param {Array<Object>} data - The dataset to sort.
     * @param {string} key - The key to sort by.
     * @param {string} direction - 'asc' or 'desc'.
     * @returns {Array<Object>} - The sorted data.
     */
    function sortData(data, key, direction) {
        return data.slice().sort((a, b) => { // Use slice() to avoid modifying the original array
            let valA = a[key];
            let valB = b[key];

            // If sorting a rating column, map the text rating to a score for accurate sorting
            if (['knowledge', 'communication', 'clarity', 'interaction'].includes(key)) {
                valA = mapRatingToScore(valA);
                valB = mapRatingToScore(valB);
                return direction === 'asc' ? valA - valB : valB - valA;
            }

            // Handle numeric values
            if (typeof valA === 'number' && typeof valB === 'number') {
                return direction === 'asc' ? valA - valB : valB - valA;
            }
            
            // Handle string values
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();

            if (valA < valB) return direction === 'asc' ? -1 : 1;
            if (valA > valB) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /**
     * Handles column header clicks to change sorting.
     * @param {string} key - The data key to sort by.
     * @param {HTMLElement} headerElement - The <th> element clicked.
     */
    function sortTable(key, headerElement) {
        let direction = 'asc';

        // Check if we are sorting the same column
        if (currentSort.key === key) {
            // Reverse direction
            direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        }

        currentSort = { key, direction };
        
        // Remove 'sorted' class and indicator from all headers
        document.querySelectorAll('#feedbackTable th').forEach(th => {
            th.classList.remove('sorted');
            const indicator = th.querySelector('.sort-indicator');
            if (indicator) indicator.innerHTML = '';
        });

        // Add 'sorted' class and indicator to the current header
        headerElement.classList.add('sorted');
        const indicator = headerElement.querySelector('.sort-indicator');
        if (indicator) {
            indicator.innerHTML = direction === 'asc' ? '▲' : '▼';
        }
        
        // Re-filter and re-render the table with the new sort order
        filterTable(); 
    }

    /**
     * Fix for CSV export compatibility with Microsoft Excel.
     */
    function exportToCSV() {
        if (feedbackData.length === 0) {
            console.warn("No data to export!");
            return;
        }

        // Sanitization function: wraps text in double quotes and escapes internal double quotes
        const sanitize = (txt) => {
            if (txt === null || txt === undefined) return '""';
            return `"${String(txt).replace(/"/g, '""')}"`;
        };

        let csv = 'ID,Student Name,Roll No,Department,Semester,Subject,Faculty,Knowledge,Communication,Clarity,Interaction,Likes,Suggestions\n';
        
        feedbackData.forEach(row => {
            // Apply sanitize consistently to all fields
            csv += [
                row.id,
                sanitize(row.studentName),
                sanitize(row.rollNo),
                sanitize(row.department),
                sanitize(row.semester),
                sanitize(row.subject),
                sanitize(row.facultyName),
                sanitize(row.knowledge), 
                sanitize(row.communication), 
                sanitize(row.clarity), 
                sanitize(row.interaction), 
                sanitize(row.likes),
                sanitize(row.suggestions)
            ].join(',') + "\n";
        });

        // Prepend the UTF-8 Byte Order Mark (BOM) for Excel compatibility
        const csvWithBOM = "\uFEFF" + csv; 

        // Set the MIME type explicitly with UTF-8 charset
        const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'feedback_data.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        console.log("Logged out. Redirecting to login page.");
        window.location.href = "/login.html"; 
    }

    // Call the data fetch/render function on load
    document.addEventListener('DOMContentLoaded', () => {
        // Mock data initialization for display purposes since API is commented out
        feedbackData = [
            // Row 1 (Dr. Singh) - High scores
            { id: 101, studentName: "Alice Johnson", rollNo: 1001, department: "CS", semester: 5, subject: "Data Structures", facultyName: "Dr. Singh", knowledge: "Excellent", communication: "Good", clarity: "Excellent", interaction: "Good", likes: "Very clear explanations and great examples.", suggestions: "More in-class coding challenges." },
            // Row 2 (Prof. Chen) - Mixed/Average
            { id: 102, studentName: "Robert Davis", rollNo: 1002, department: "EE", semester: 3, subject: "Circuit Theory", facultyName: "Prof. Chen", knowledge: "Average", communication: "Average", clarity: "Good", interaction: "Average", likes: "Prof. Chen is very knowledgeable.", suggestions: "The lecture pace is sometimes too fast, slowing down would help." },
            // Row 3 (Dr. Singh) - Highest scores
            { id: 103, studentName: "Sarah Connor", rollNo: 1003, department: "CS", semester: 5, subject: "OS", facultyName: "Dr. Singh", knowledge: "Excellent", communication: "Excellent", clarity: "Excellent", interaction: "Excellent", likes: "Outstanding faculty, engaging lectures.", suggestions: "None, everything is great." },
            // Row 4 (Dr. Ahmed) - Low scores
            { id: 104, studentName: "Jian Li", rollNo: 1004, department: "ME", semester: 7, subject: "Thermodynamics", facultyName: "Dr. Ahmed", knowledge: "Poor", communication: "Good", clarity: "Poor", interaction: "Average", likes: "Good use of real-world examples.", suggestions: "Please review fundamental concepts more thoroughly." },
            // Row 5 (Prof. Chen) - Low scores
            { id: 105, studentName: "Emma Brown", rollNo: 1005, department: "EE", semester: 3, subject: "Digital Logic", facultyName: "Prof. Chen", knowledge: "Good", communication: "Poor", clarity: "Average", interaction: "Poor", likes: "Assignments were fair.", suggestions: "Needs better organization of course material." }
        ];

        // Initial render with default sort
        const sortedData = sortData(feedbackData, currentSort.key, currentSort.direction);
        renderTable(sortedData);
        updateMetrics(feedbackData); 

        // Set default sort indicator
        const defaultHeader = document.querySelector('th[data-sort-key="id"]');
        if (defaultHeader) {
            defaultHeader.classList.add('sorted');
            const indicator = defaultHeader.querySelector('.sort-indicator');
            if (indicator) indicator.innerHTML = currentSort.direction === 'asc' ? '▲' : '▼';
        }
    });

</script>

</body>
</html>